{% extends "main_app/base.html" %}
{% block content %}




    <div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>

    <div class="container" id="container"></div>

    <script type="text/html" id="tpl_tabbar">
        <div class="page">
        <div class="page__bd page__bd_spacing" style="height: 100%;">
                <div class="weui-tab">
                    <div class="weui-tab__panel">


                        <div class="weui-tab__content tab_active" id="o_onHand">
                            <div class="weui-panel__hd">Order on hand</div>
                            <div class="weui-form-preview" id="tab_oh">
                                
                            </div>
                        </div>




                        <div class="weui-tab__content" id="o_history">
                            <div class="weui-panel__hd">History</div>
                            <div class="weui-panel__bd">
                                <div class="weui-form-preview" id="order_history_tab">
                                </div>
                                    
                            </div>
                        </div>

                        
                        <div class="weui-tab__content" id="menu_mgnt">
                            <div class="weui-panel__hd">
                                <div class="weui-flex">
                                    <div class="weui-flex__item"><div class="placeholder">Menu Management </div></div>
                                    <div class="weui-flex__item"><div class="placeholder">
                                        <i class="weui-icon-download" style="float: right;" id="addBtn"></i>
                                    </div></div>
                                </div>
                            </div>
                            <div class="weui-panel__bd">
                                <div class="weui-form-preview" id="menu_mgnt_content">
                                    
                                </div> 
                            </div> 
                            <div class="weui-panel__ft">
                                
                            </div>  
                        </div> 
            <!--BEGIN toast-->
            <div id="toast" style="display: none;">
                <div class="weui-mask_transparent"></div>
                <div class="weui-toast">
                    <i class="weui-icon-success-no-circle weui-icon_toast"></i>
                    <p class="weui-toast__content">Saved</p>
                </div>
            </div>
            <!--end toast-->                   
        </div>
        <div id="dialogs">
            <!--BEGIN deleteDialog-->
            <div class="js_dialog" id="deleteDialog" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd"><strong class="weui-dialog__title">Delete confirmation</strong></div>
                    <div class="weui-dialog__bd">After delete this process cannot be undone, are you sure?</div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default">cancle</a>
                        <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">delete</a>
                    </div>
                </div>
            </div>
            <!--END deleteDialog-->
            <!--BEGIN newDialog-->
            <div class="js_dialog" id="newDialog" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd"><strong class="weui-dialog__title">New Menu</strong></div>
                    <div class="weui-dialog__bd">
                        <div class="weui-cells weui-cells_form">
                            <div class="weui-cell">
                                <div class="weui-cell__bd">
                                    <div class="weui-uploader">
                                        <div class="weui-uploader__bd">                                     
                                            <div class="weui-uploader__input-box">
                                                <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="weui-cell">
                            <div class="weui-cell__hd"><label class="weui-label">Name</label></div>
                            <div class="weui-cell__bd">
                                <textarea class="weui-textarea" placeholder="menu name" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="weui-cells__title">Price preferences</div>
                        <div class="weui-cells weui-cells_form">
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">small box</label></div>
                                <div class="weui-cell__bd">
                                    <input class="weui-input" type="number" pattern="[0-9]*" placeholder="0"/>
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">medium box</label></div>
                                <div class="weui-cell__bd">
                                    <input class="weui-input" type="number" pattern="[0-9]*" placeholder="0"/>
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd"><label class="weui-label">large box</label></div>
                                <div class="weui-cell__bd">
                                    <input class="weui-input" type="number" pattern="[0-9]*" placeholder="0"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default">cancle</a>
                        <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="saveBtn">save</a>
                    </div>
                </div>
            </div>
            <!--END newDialog-->

        </div>
    </div>
</div>
<div class="weui-tabbar">
    <a href="javascript:;" class="weui-tabbar__item weui-bar__item_on" data-id="o_onHand">
        <span style="display: inline-block;position: relative;">
            <img src="{{ STATIC_URL }}/assets/images/icon_tabbar.png" alt="" class="weui-tabbar__icon">
            <span class="weui-badge-success" style="position: absolute;top: -2px;right: -13px;" id="count_order_oh"></span>
        </span>
        <p class="weui-tabbar__label">Order on hand</p>
    </a>
    <a href="javascript:;" class="weui-tabbar__item" data-id="o_history">
        <span style="display: inline-block;position: relative;">
            <img src="{{ STATIC_URL }}/assets/images/icon_tabbar.png" alt="" class="weui-tabbar__icon">
            <span class="weui-badge-warning" style="position: absolute;top: -2px;right: -13px;" id="count_oh"></span>
        </span>
        <p class="weui-tabbar__label">Order history</p>
    </a>
    <a href="javascript:;" class="weui-tabbar__item" data-id="menu_mgnt">
        <span style="display: inline-block;position: relative;">
            <img src="{{ STATIC_URL }}/assets/images/icon_tabbar.png" alt="" class="weui-tabbar__icon">
            <span class="weui-badge-danger" style="position: absolute;top: -2px;right: -13px;" id="count_mm"></span>
        </span>
        <p class="weui-tabbar__label">Menu management</p>
    </a>
</div>
</div>
</div>
</div>





<!--BEGIN toast-->
    <div id="toast_success" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-success-no-circle weui-icon_toast"></i>
            <p class="weui-toast__content">Success</p>
        </div>
    </div>
    <!--end toast-->




<script type="text/javascript">
    $(function(){
        $('.weui-tabbar__item').on('click', function () {        
            $(this).addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
            
            var id = $(this).data('id');
            // console.log(id);
            $('.tab_active').fadeOut('fast',function(){
                $(this).removeClass('tab_active');
                $('#'+id).fadeIn('fast',function(){
                    $(this).addClass('tab_active');
                });
            });
            get_all_data();
        });
        var $toast = $('#toast');
        $('#saveBtn').on('click', function(){
            if ($toast.css('display') != 'none') return;

            $toast.fadeIn(100);
            setTimeout(function () {
                $toast.fadeOut(100);
            }, 2000);
        });
        var $deleteDialog = $('#deleteDialog');
        var $newDialog = $('#newDialog');
        

        $('#dialogs').on('click', '.weui-dialog__btn', function(){
            $(this).parents('.js_dialog').fadeOut(200);
        });
        $('.deleteBtn').on('click', function(){
            $deleteDialog.fadeIn(200);
        });        
        $('#addBtn').on('click', function(){
            $newDialog.fadeIn(200);
        });

    });


    
    var store_id = 5;
    var user_id = 2;

    $(document).ready(function() {
        get_all_data();
    });

    function get_all_data(){
        // get_order_on_hand();
        get_supplier_order_history();
        get_supplier_menu_list();
        get_supplier_on_hand();
    }

    setTimeout(function(){
        get_all_data()
    }, 30000);



    function show_toast(){
        var $toast = $('#toast_success');
        if ($toast.css('display') != 'none') return;
        $toast.fadeIn(100);
        setTimeout(function () {
            $toast.fadeOut(100);
        }, 2000);
    }








    function get_supplier_on_hand(){
        var data =     {
                "OWNER_ID"   : "3",

        }
        $.ajax({
            url: "get_supplier_on_hand",
            data: data,
            type: "POST",
            dataType: 'json',
            success: function (json) {
                $("#tab_oh").empty();
                if(_.isEmpty(json)==false){
                    $.each(json, function (i, v) {
                        if(_.isEmpty(v.MENU_ID)==false || v.MENU_ID!=null){
                            

                            var tab_on_bd ='';

                            $.ajax({
                                url: "get_supplier_on_hand_detail",
                                data: {"OWNER_ID": v.OWNER_ID, "ORDER_ID" :v.ORDER_ID},
                                type: "POST",
                                dataType: 'json',
                                success: function (json2) {
                                    // console.log(json2);
                                    if(_.isEmpty(json2)==false){
                                        $("#tab_on_bd").empty();
                                        $.each(json2, function (m, n) {
                                            if(_.isEmpty(n.MENU_ID)==false || n.MENU_ID!=null){
                                                    tab_on_bd = '<a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg" data-id="'+n.ORDER_ID+'">'+
                                                        '<div class="weui-media-box__hd">'+
                                                            '<img class="weui-media-box__thumb" src="data:image/png;base64,'+n.MENU_IMG+'" alt="">'+
                                                        '</div>'+
                                                        '<div class="weui-media-box__bd">'+
                                                            '<h4 class="weui-media-box__title">'+n.MENU_NAME+' (¥'+n.PRICE+')</h4>'+
                                                            '<p class="weui-media-box__desc">Box size: '+n.MENU_DETAIL+'</p>'+
                                                            '<p class="weui-media-box__desc">Amount : '+n.AMOUNT+'</p>'+
                                                            '<p class="weui-media-box__desc">Order on '+new Date(n.TIME_STAMP).toDateString()+'</p>'+
                                                        '</div>'+
                                                    '</a>';
                                                    $("#tab_on_bd_"+n.ORDER_ID).append(tab_on_bd);
                                            }
                                            // console.log()
                                        });
                                    }
                                }
                            });
                            $("#tab_oh").append(
                                '<div class="weui-form-preview__hd" style="text-align: left;" id="tab_on_hd">'+
                                    '<div class="weui-form-preview__item">'+
                                        '<em class="weui-form-preview__value">Order Id: '+v.ORDER_ID+'</em>'+
                                    '</div>'+
                                '</div>'+


                                '<div class="weui-form-preview__bd" style="text-align: left;"  id="tab_on_bd_'+v.ORDER_ID+'">'+
                                    tab_on_bd+
                                '</div>'+


                                '<div class="weui-form-preview__fd" id="tab_on_ft">'+
                                   ' <a href="#" class="weui-btn weui-btn_plain-primary btnSubmitOH" data="'+v.ORDER_ID+'">Submit</a>'+
                                '</div><br/><hr/>'
                            );


                            $("#count_order_oh").text(json.length);
                        }else{
                            $("#tab_task_on_process").hide();
                        }
                    });
                    
                    
                }
            }
        });
    }


    $("#tab_oh").on("click", ".btnSubmitOH", function(){
        // console.log()
        $.ajax({
            url: "confirm_supplier_on_hand",
            data: {"ORDER_ID": $(this).attr("data")},
            type: "POST",
            dataType: 'json',
            success: function (json) {
                show_toast();
                get_all_data();
            }
        });
    });







    function get_supplier_order_history(){
        var data =     {
                "OWNER_ID"   : "3",

        }
        $.ajax({
            url: "get_supplier_order_history",
            data: data,
            type: "POST",
            dataType: 'json',
            success: function (json) {
                $("#order_history_tab").empty();
                if(_.isEmpty(json)==false){
                    $.each(json, function (i, v) {
                        if(_.isEmpty(v.MENU_ID)==false || v.MENU_ID!=null){
                            
                            var tab_on_bd ='', total=0;

                            $.ajax({
                                url: "get_supplier_order_history_detail",
                                data: {"OWNER_ID": v.OWNER_ID, "ORDER_ID" :v.ORDER_ID},
                                type: "POST",
                                dataType: 'json',
                                success: function (json2) {
                                    // console.log(json2);
                                    if(_.isEmpty(json2)==false){
                                        $("#tab_hon_bd_"+v.ORDER_ID).empty();
                                        $.each(json2, function (m, n) {
                                            // console.log(json2)
                                            if(_.isEmpty(n.MENU_ID)==false || n.MENU_ID!=null){
                                                    
                                                    tab_on_bd = '<div class="weui-form-preview__item">'+
                                                                    '<label class="weui-form-preview__label">Order Id</label>'+
                                                                    '<span class="weui-form-preview__value">'+n.ORDER_ID+'</span>'+
                                                                '</div>'+
                                                                '<div class="weui-form-preview__item">'+
                                                                    '<label class="weui-form-preview__label">Order name</label>'+
                                                                    '<span class="weui-form-preview__value">'+n.MENU_NAME+'</span>'+
                                                                '</div>'+
                                                                '<div class="weui-form-preview__item">'+
                                                                    '<label class="weui-form-preview__label">Order Detail</label>'+
                                                                    '<span class="weui-form-preview__value">'+n.MENU_DETAIL+'</span>'+
                                                                '</div>'+
                                                                '<div class="weui-form-preview__item">'+
                                                                    '<label class="weui-form-preview__label">Order Zize</label>'+
                                                                    '<span class="weui-form-preview__value">'+n.MENU_SIZE+'</span>'+
                                                                '</div>'+
                                                                '</div>'+
                                                                '<div class="weui-form-preview__item">'+
                                                                    '<label class="weui-form-preview__label">Amount</label>'+
                                                                    '<span class="weui-form-preview__value">'+n.AMOUNT+'</span>'+
                                                                '</div>'+
                                                                '<div class="weui-form-preview__item">'+
                                                                    '<label class="weui-form-preview__label">Data of delivery</label>'+
                                                                    '<span class="weui-form-preview__value">'+new Date(n.TIME_STAMP).toDateString()+'</span>'+
                                                                '</div>';
                                                    $("#tab_hon_bd_"+n.ORDER_ID).append(tab_on_bd);
                                            }
                                            // console.log()
                                        });
                                    }
                                }
                            });
                            total = v.PRICE * v.AMOUNT;
                            $("#order_history_tab").append(
                                '<div class="weui-form-preview__hd" id="tab_on_hd">'+
                                    '<div class="weui-form-preview__item">'+
                                        '<label class="weui-form-preview__label">Order Payment</label>'+
                                        // '<em class="weui-form-preview__value">¥'+v.PRICE+'</em>'+
                                    '</div>'+
                                '</div>'+


                                '<div class="weui-form-preview__bd" style="text-align: left;"  id="tab_hon_bd_'+v.ORDER_ID+'">'+
                                    tab_on_bd+
                                '</div>'+

                                '<div class="weui-form-preview__hd" id="tab_on_ft">'+
                                    '<div class="weui-form-preview__item">'+
                                        '<label class="weui-form-preview__label">Total</label>'+
                                        '<em class="weui-form-preview__value">¥'+total+'</em>'+
                                    '</div>'+
                                '</div>'+
                                '<br/><hr/>'
                            );


                        $("#count_oh").text(json.length);
                            
                        }else{
                            $("#tab_task_on_process").hide();
                        }
                    });
                    
                    
                }
            }
        });
    }





    function get_supplier_menu_list(){

        $.ajax({
            url: "get_supplier_menu_list",
            data: {"OWNER_ID"   : "3"},
            type: "POST",
            dataType: 'json',
            success: function (json) {
                // console.log(json);
                $("#menu_mgnt_content").empty();
                if(_.isEmpty(json)==false){
                    $.each(json, function (i, v) {
                        var s_price =0, m_price =0, l_price =0;
                        var status ='';
                        
                        if(v.MENU_STATUS == 1){status ='checked="checked"'}

                        split_parcel = v.PARCEL_DESC.split(",");
                        $.each(split_parcel, function (p, q) {
                            split_split = q.split("|");
                            if(split_split[0]=='small'){s_price=split_split[1]}
                            if(split_split[0]=='medium'){m_price=split_split[1]}
                            if(split_split[0]=='large'){l_price=split_split[1]}
                        });


                        $("#menu_mgnt_content").append(
                            '<a href="#" class="weui-media-box weui-media-box_appmsg" >'+
                                        
                                '<div class="weui-media-box__hd">'+
                                    '<img class="weui-media-box__thumb" src="data:image/png;base64,'+v.MENU_IMG+'" alt="">'+
                                    '<i class="weui-icon-cancel deleteBtn"></i>'+
                                '</div>'+
                                '<div class="weui-media-box__bd">'+
                                    '<h4 class="weui-media-box__title"><b>'+v.MENU_NAME+'</b></h4>'+
                                    // '<h4 class="weui-media-box__title">'+v.MENU_DETAIL+'</h4>'+
                                    '<div class="weui-cells__title">Price</div>'+
                                    '<div class="weui-cells weui-cells_form">'+
                                        '<div class="weui-cell">'+
                                            '<div class="weui-cell__hd"><label class="weui-label">small box</label></div>'+
                                            '<div class="weui-cell__bd">'+
                                                '<input class="weui-input s_price" value="'+s_price+'" data="'+v.MENU_ID+'" type="number" pattern="[0-9]*" placeholder="0"/>'+
                                            '</div>'+
                                        '</div>'+
                                        '<div class="weui-cell">'+
                                            '<div class="weui-cell__hd"><label class="weui-label">medium box</label></div>'+
                                            '<div class="weui-cell__bd">'+
                                                '<input class="weui-input m_price" value="'+m_price+'" data="'+v.MENU_ID+'" type="number" pattern="[0-9]*" placeholder="0"/>'+
                                            '</div>'+
                                        '</div>'+
                                        '<div class="weui-cell">'+
                                            '<div class="weui-cell__hd"><label class="weui-label">large box</label></div>'+
                                            '<div class="weui-cell__bd">'+
                                                '<input class="weui-input l_price" value="'+l_price+'" data="'+v.MENU_ID+'" type="number" pattern="[0-9]*" placeholder="0"/>'+
                                            '</div>'+
                                        '</div>'+
                                        '<div class="weui-cell weui-cell_switch">'+
                                            '<div class="weui-cell__bd">sale</div>'+
                                            '<div class="weui-cell__ft">'+
                                                '<input class="weui-switch menu_check_status" data="'+v.MENU_ID+'" '+status+' type="checkbox"/>'+
                                            '</div>'+
                                        '</div>' +                                
                                    '</div>'+
                                '</div>'+
                                '<div class="weui-media-box__ft" style="margin-top:-30px">'+
                                    '<div class="weui-form-preview">'+
                                        '<a href="#" class="weui-btn weui-btn_plain-primary btnSubmitMM" data="'+v.MENU_ID+'">Save</a>'+
                                    '</div>'+
                                '</div>'+
                            '</a><br/><hr/>'
                        );
                    });
                    $("#count_mm").empty().append(json.length);
                }
            }
        });
    }


    $("#menu_mgnt_content").on("click", ".btnSubmitMM", function(){
        var box_s, box_m, box_l, status;


        if($(".menu_check_status").prop("checked") == true){
            status = 1;
        }else{
            status =0;
        }


        if($(".s_price").attr("data") == $(this).attr("data")){
            box_s=$(".s_price").val();
            update_mm($(this).attr("data"), "small", box_s, status);
        }
        if($(".m_price").attr("data") == $(this).attr("data")){
            box_m=$(".m_price").val();
            update_mm($(this).attr("data"), "medium", box_m, status);
        }
        if($(".l_price").attr("data") == $(this).attr("data")){
            box_l=$(".l_price").val();
            update_mm($(this).attr("data"), "large", box_l, status);
        }
        
        
    });
    
    function update_mm(data_id, type, val, status){
        data = {
            "menu_id" : data_id,
            "type"    : type,
            "val"     : val,
            "status"  : status
        }
        $.ajax({
            url: "update_menu_supplier",
            data: data,
            type: "POST",
            dataType: 'json',
            success: function (json) {
                console.log(json);
                show_toast();
                get_all_data();
            }
        });
    }












    /**
    function get_order_on_hand(){
        var data =     {
                "store_id"   : store_id,

            }
        $.ajax({
            url: "get_order_on_hand",
            data: data,
            type: "POST",
            dataType: 'json',
            success: function (json) {
                // keys= ('menu_id', 'menu_name', 'menu_detail', 'menu_img', 'menu_status', 'price', 'store_id', 'customer_id', 'order_status', 'date_order', 'order_size')
            
                if(_.isEmpty(json)==false){
                    $("#on_hand_tab").empty();
                    var is_match = new Array();
                    $.each(json, function (i, v) {
                        if(_.isEmpty(JSON.parse(v))==false){
                            $.each(JSON.parse(v), function (j, k) {
                                var split_size = k.order_size.split(",");
                                $.each(split_size, function (x, y) {
                                    var y_split = y.split("|");
                                    var conf_btn = '';


                                    if(_.contains(is_match, k.order_id)==false){
                                        if(_.last(is_match) == true){
                                             conf_btn = '<div class="weui-media-box__ft" style="margin-top:-40px;text-align=center;float: center;display: grid;">'+
                                                    '<a href="#" class="weui-btn weui-btn_mini weui-btn_primary btn_confirm_onhand" order_id="'+k.order_id+'"  customer_id="'+k.customer_id+'">Confirm</a>'+
                                                '</div>'; 
                                        }else{
                                            is_match.push(k.order_id);
                                            conf_btn = '';
                                            // console.log("nm");
                                        }
                                    }else{
                                        conf_btn = '<div class="weui-media-box__ft" style="margin-top:-40px;text-align=center;float: center;display: grid;">'+
                                                    '<a href="#" class="weui-btn weui-btn_mini weui-btn_primary btn_confirm_onhand" order_id="'+k.order_id+'"  customer_id="'+k.customer_id+'">Confirm</a>'+
                                                '</div>'; 
                                        // console.log("m")  
                                    }
                                    
                                    if(k.menu_id == y_split[0]){
                                        $("#on_hand_tab").append(
                                            '<a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg" data-id="'+k.order_id+'">'+
                                                '<div class="weui-media-box__hd">'+
                                                    '<img class="weui-media-box__thumb" src="data:image/png;base64,'+k.menu_img+'" alt="">'+
                                                '</div>'+
                                                '<div class="weui-media-box__bd">'+
                                                    '<h4 class="weui-media-box__title">'+k.menu_name+'</h4>'+
                                                    '<p class="weui-media-box__desc">Box size: '+y_split[1]+' ['+k.menu_detail+'] x '+y_split[0]+'</p>'+
                                                    '<p class="weui-media-box__desc">Order on '+new Date(k.date_order).toDateString()+'</p>'+
                                                '</div>'+
                                                conf_btn+
                                            '</a>'
                                        );
                                        $("#count_order_oh").empty().text(json.length);
                                    }
                                });
                                
                            });
                        }
                    });
                    
                }else{
                    // is empy json ??
                }
            },
            error: function(){
                // alert('failure');
            }
        });
    }


    $("#on_hand_tab").on("click", ".btn_confirm_onhand", function(){
        var data =     {
                "order_id"   : $(this).attr("order_id")

            }
        $.ajax({
            url: "order_on_hand_confirm",
            data: data,
            type: "POST",
            dataType: 'json',
            success: function (json) {
                get_order_on_hand();
            }
        });
    });
        




z        var data =     {
                "store_id"   : 2
            }
        $.ajax({
            url: "get_supplier_order_history",
            data: data,
            type: "POST",
            dataType: 'json',
            success: function (json) {
                // keys= ('menu_id', 'menu_name', 'menu_detail', 'menu_img', 'menu_status', 'price', 'store_id', 'customer_id', 'order_status', 'date_order', 'order_size')
                if(_.isEmpty(json)==false){
                    $("#order_history_tab").empty();
                    var is_match = new Array();
                    var total =new Array();
                    $.each(json, function (i, v) {
                        if(_.isEmpty(JSON.parse(v))==false){
                            $.each(JSON.parse(v), function (j, k) {
                                var split_size = k.order_size.split(",");
                                var split_price = k.price.split(",");
                                $.each(split_size, function (x, y) {
                                    var y_split = y.split("|");
                                    var footer = '';
                                    var header = '';
                                    var price='', total_per_box='';
                                    var myTotal = 0;


                                    if(y_split[1]=="small"){
                                        price = split_price[0];
                                    }else if(y_split[1]=="medium"){
                                        price = split_price[1];
                                    }else{
                                        price = split_price[2];
                                    }
                                    total_per_box = price*y_split[0];
                                    
                                    if(_.contains(total, total_per_box)==false){
                                        total.push(total_per_box);    
                                    }
                                    for(var i = 0; i < total.length; i++) {
                                        myTotal += total[i]<<0;  // Iterate over your first array and then grab the second element add the values up
                                    }



                                    if(_.contains(is_match, k.order_id)==false){
                                        if(_.last(is_match) == true){
                                            // header = '<a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg" style="margin-top:-5px;margin-bottom:-5px">'+
                                            //             '<div class="weui-form-preview__item">'+
                                            //                 '<label class="weui-form-preview__label">Order number</label>'+
                                            //                 '<span class="weui-form-preview__value">'+k.order_id+'</span>'+
                                            //             '</div>'+
                                            //        ' </a>';
                                            footer = '<a href="#" class="weui-media-box weui-media-box_appmsg" style="margin-top:-5px;margin-bottom:-5px">'+
                                                    '<div class="weui-form-preview__item">'+
                                                        '<label class="weui-form-preview__label">Date</label>'+
                                                        '<span class="weui-form-preview__value">'+new Date(k.date_order).toDateString()+'</span>'+
                                                        '<label class="weui-form-preview__label">Price</label>'+
                                                        '<span class="weui-form-preview__value">'+myTotal+' ¥</span>'+
                                                    '</div>'
                                                '</a>'; 
                                        }else{
                                            is_match.push(k.order_id);
                                            conf_btn = '';
                                            // console.log("nm");
                                        }
                                    }else{
                                        header = '<a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg" style="margin-top:-5px;margin-bottom:-5px">'+
                                                        '<div class="weui-form-preview__item">'+
                                                            '<label class="weui-form-preview__label">Order number</label>'+
                                                            '<span class="weui-form-preview__value">'+k.order_id+'</span>'+
                                                        '</div>'+
                                                   ' </a>'; 
                                        // $("#order_history_tab").prepend(header);
                                        footer = '<a href="#" class="weui-media-box weui-media-box_appmsg" style="margin-top:-5px;margin-bottom:-5px">'+
                                                    '<div class="weui-form-preview__item">'+
                                                        '<label class="weui-form-preview__label">Date</label>'+
                                                        '<span class="weui-form-preview__value">'+new Date(k.date_order).toDateString()+'</span>'+
                                                        '<label class="weui-form-preview__label">Price</label>'+
                                                        '<span class="weui-form-preview__value">'+myTotal+' ¥</span>'+
                                                    '</div>'
                                                '</a>'; 
                                        // console.log("m")  
                                    }


                                   

                                    
                                    // console.log(myTotal);
                                    
                                    if(k.menu_id == y_split[0]){
                                        $("#order_history_tab").append(
                                            // header+
                                            '<a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg" data-id="'+k.order_id+'">'+
                                                '<div class="weui-media-box__hd">'+
                                                    '<img class="weui-media-box__thumb" src="data:image/png;base64,'+k.menu_img+'" alt="">'+
                                                '</div>'+
                                                '<div class="weui-media-box__bd">'+
                                                    '<h4 class="weui-media-box__title">'+k.menu_name+'</h4>'+
                                                    '<p class="weui-media-box__desc">Box size: '+y_split[1]+' ['+k.menu_detail+']</p>'+
                                                    '<p class="weui-media-box__desc"> '+y_split[0]+' x '+price+'¥ ('+total_per_box+'¥)</p>'+
                                                '</div>'+
                                                footer+
                                            '</a>'
                                        );
                                        $("#count_oh").empty().text(json.length);
                                    }
                                });
                                
                            });
                        }
                    });
                    
                }else{
                    // is empy json ??
                }
            },
            error: function(){
                // alert('failure');
            }
        });
    }





    function test_ajax(){
        $.get("test_new_user", function(json){
            console.log(json);
        });
    }
    **/
</script>



<!-- <script src="{{ STATIC_URL }}/assets/js/jquery-2.1.4.min.js"></script> -->
<script src="{{ STATIC_URL }}/assets/js/underscore-min.js"></script>




{% endblock %}